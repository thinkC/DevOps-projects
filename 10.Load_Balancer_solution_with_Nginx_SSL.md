

## Step 1 - CONFIGURE NGINX AS A LOAD BALANCER

1. We create an EC2 VM with Ubuntu server 20.04 LTS and name is `Nginx LB` and also allow inbound traffic on port 22 for SSH, port 80 for HTTP and port 443 for HTTPS . HTTPS is used for secure connections.

2. Update `/etc/hosts` file for local DNS with Web servers names as web1 and web2 with their local IP addreses

```bash
sudo nano /etc/hosts
```

![local dns](./img-lb-nginx/img2.png)
3. We install and configure Nginx as a load balancer to pint traffic to resolvable DNS names of the s=web servers.

```bash
sudo apt update
sudo apt install nginx
```

We now configire `Nginx LB` to use web servers names we defined in `/etc/hosts`

```bash
#sudo sudo /etc/nginx/nginx.conf
sudo nano /etc/nginx/sites-available/load_balancer.conf

#insert following configuration into http section

 upstream web {
    server 34.207.189.10;
    server 54.82.180.24;
  }

server {
    listen 80;
    server_name www.domain.com;
    location / {
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_pass http://web;
    }
  }


```

![nginx](./img-lb-nginx/img3.png)

Restart nginx and check status

```bash
sudo systemctl restart nginx
sudo systemctl status nginx
```

```bash
ubuntu@ip-172-31-4-110:~$ sudo systemctl status nginx
● nginx.service - A high performance web server and a reverse proxy server
     Loaded: loaded (/lib/systemd/system/nginx.service; enabled; vendor preset: enabled)
     Active: active (running) since Mon 2021-07-12 14:02:05 UTC; 20s ago
       Docs: man:nginx(8)
   Main PID: 14515 (nginx)
      Tasks: 2 (limit: 1160)
     Memory: 3.0M
     CGroup: /system.slice/nginx.service
             ├─14515 nginx: master process /usr/sbin/nginx -g daemon on; master_process on;
             └─14516 nginx: worker process

Jul 12 14:02:05 ip-172-31-4-110 systemd[1]: Starting A high performance web server and a reverse proxy server.>
Jul 12 14:02:05 ip-172-31-4-110 systemd[1]: Started A high performance web server and a reverse proxy server.
```

Enable Nginx

```bash
sudo systemctl enable nginx
```

output

```bash
Synchronizing state of nginx.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable nginx
```

<!-- We can learn more on HTTP load balancing [here](https://docs.nginx.com/nginx/admin-guide/load-balancer/http-load-balancer/) -->

Step 2 - REGISTER A NEW DOMAIN NAME AND CONFIGURE SECURED CONNECTION USING SSL/TLS CERTIFICATES

We will now register a new domain name and configure a secure connection using SSL/TLS certificate.

1. Register a new domain e.g. Godday.com, Domain.com, Bluehost.com and freenom.com . Here I have registered `toolingwebapp.ml`

2. Next we assign an Elastic IP to our Nginx LB server and associate our domain name with it. Since, we will be charged for using elastic IP, we will go ahaead with the Public IP.

3. We go to `Route 53 on AWS ` and create hosted zone

![route53](./img-lb-nginx/img4.png)

![route53](./img-lb-nginx/img5.png)

![route53](./img-lb-nginx/img6.png)
We will then need add the name servers on AWS route 53 to our free domain web host site.

On Freenom click on Management Tools and click Nameservers

![route53](./img-lb-nginx/img7.png)

Click on _use custom namedservers and add the AWS named servers and click change the Nameservers

![route53](./img-lb-nginx/img8.png)

Now our free domain now is now connected to AWS Route53!.

![route53](./img-lb-nginx/img9.png)

Next we create `A record` on AWS Route53

click on create record
![route53](./img-lb-nginx/img10.png)

Here, our A record will be pointing to the nginx loadbalancer server.  

A record created . We add our Public IP
![route53](./img-lb-nginx/img11.png)

Add `www` and Public IP
![route53](./img-lb-nginx/img12.png)

![route53](./img-lb-nginx/img13.png)

Back to our Nginx server, edit `load_balancer.conf`

`sudo nano /etc/nginx/sites-available/load_balancer.conf`

```bash
 upstream web {
    server 34.207.189.10;
    server 54.82.180.24;
  }

server {
    listen 80;
    server_name toolingwebapp.ml www.toolingwebapp.ml;
    location / {
      proxy_set_header x-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_pass http://web;
    }
  }
```
Next we remove our default site so that nginx will point u sto our newly created config file.

```bash
sudo rm -f /etc/nginx/sites-enabled/default
```

Next check if nginx is configured properly

We remove ...

```bash
sudorm -f /etc/nginx/sites-enabled/default
```

```bash
sudo nginx -t
```

output
```bash
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
```

Next cd to sites-enabled , it is now empty since we removed it above

```bash
cd /etc/nginx/sites-enabled/
```


Now we need to link our load balancer config file we created in our sites available to our site enabled. This will aloow nginx to access our configuration.

```bash
sudo ln -s ../sites-available/load_balancer.conf .
```

output

```bash
ubuntu@ip-172-31-4-110:/etc/nginx/sites-enabled$ sudo ln -s ../sites-available/load_balancer.conf .
ubuntu@ip-172-31-4-110:/etc/nginx/sites-enabled$ ls
load_balancer.conf
```
Checking to see if it is linked.
```bash
ubuntu@ip-172-31-4-110:/etc/nginx/sites-enabled$ ll
total 8
drwxr-xr-x 2 root root 4096 Jul 12 19:53 ./
drwxr-xr-x 8 root root 4096 Jul 12 19:25 ../
lrwxrwxrwx 1 root root   37 Jul 12 19:53 load_balancer.conf -> ../sites-available/load_balancer.conf
ubuntu@ip-172-31-4-110:/etc/nginx/sites-enabled$
```

Reload nginx

```bash
sudo systemctl reload nginx
```