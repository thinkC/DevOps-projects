# Project - 13 - ANSIBLE DYNAMIC ASSIGNMENTS (INCLUDE) AND COMMUNITY ROLES

We start by creating a new branch in our repository

```bash
git checkout -b dynamic-assignments
```
output

```bash
Switched to a new branch 'dynamic-assignments'
```

Next we create folder `dynamic-assignments`

```bash
mkdir dynamic-assignments
````

output

```
ubuntu@ip-172-31-62-121:~/ansible-config-mgt$ ls -l
total 28
-rw-rw-r-- 1 ubuntu ubuntu   74 Jul 19 15:55 README.md
drwxrwxr-x 3 ubuntu ubuntu 4096 Jul 16 20:47 ansible-config-mgt
drwxrwxr-x 2 ubuntu ubuntu 4096 Jul 20 15:40 dynamic-assignments
drwxrwxr-x 2 ubuntu ubuntu 4096 Jul 17 10:50 inventory
drwxrwxr-x 2 ubuntu ubuntu 4096 Jul 19 15:11 playbooks
drwxrwxr-x 3 ubuntu ubuntu 4096 Jul 19 18:47 roles
drwxrwxr-x 2 ubuntu ubuntu 4096 Jul 19 20:08 static-assignments
```

Next, create a folder named `env-vars` to keep each of our environment variable file.

```bash
mkdir env-vars
cd env-vars
touch dev.yml stage.yml uat.yml prod.yml
```

output

```bash
ubuntu@ip-172-31-62-121:~/ansible-config-mgt/env-vars$ ls -l
total 0
-rw-rw-r-- 1 ubuntu ubuntu 0 Jul 20 16:03 dev.yml
-rw-rw-r-- 1 ubuntu ubuntu 0 Jul 20 16:03 prod.yml
-rw-rw-r-- 1 ubuntu ubuntu 0 Jul 20 16:03 stage.yml
-rw-rw-r-- 1 ubuntu ubuntu 0 Jul 20 16:03 uat.yml
ubuntu@ip-172-31-62-121:~/ansible-config-mgt/env-vars$ 
```

Our folder structure should look like this.

**Note**: Under inventory, the files should be `dev`, `prod`, `staging`, `uat`.

![folder layout](https://github.com/thinkC/devops-projects/blob/master/img-ansible1/img1.PNG?raw=true)

The code below will be added into `env-vars.yml`

```yml
---
- name: collate variables from env specific file, if it exists
  hosts: all
  tasks:
    - name: looping through list of available files
      include_vars: "{{ item }}"
      with_first_found:
        - files:
            - dev.yml
            - stage.yml
            - prod.yml
            - uat.yml
          paths:
            - "{{ playbook_dir }}/../env-vars"
      tags:
        - always
```

Update `site.yml` with dynamic assignment

```yml
---
- hosts: all
- name: Include dynamic variables 
  tasks:
  import_playbook: ../static-assignments/common.yml 
  include: ../dynamic-assignments/env-vars.yml
  tags:
    - always

-  hosts: webservers
- name: Webserver assignment
  import_playbook: ../static-assignments/webservers.yml
```

We commit all our changes with `dynamic-assignments` branch and merge it with our main branch. We then push to our `ansible-config-mgt` repository.

output
```bash
ubuntu@ip-172-31-62-121:~/ansible-config-mgt$ git status
On branch dynamic-assignments
Untracked files:
  (use "git add <file>..." to include in what will be committed)
        dynamic-assignments/
        env-vars/
        roles/mysql/

nothing added to commit but untracked files present (use "git add" to track)
ubuntu@ip-172-31-62-121:~/ansible-config-mgt$ git add .

ubuntu@ip-172-31-62-121:~/ansible-config-mgt$ git commit -m "added new roles"
[dynamic-assignments a9d7825] added new roles
 Committer: Ubuntu <ubuntu@ip-172-31-62-121.ec2.internal>
Your name and email address were configured automatically based
on your username and hostname. Please check that they are accurate.
You can suppress this message by setting them explicitly. Run the
following command and follow the instructions in your editor to edit
your configuration file:

    git config --global --edit

After doing this, you may fix the identity used for this commit with:

    git commit --amend --reset-author

 38 files changed, 1219 insertions(+)
 create mode 100644 dynamic-assignments/env-vars.yml
 create mode 100644 env-vars/dev.yml
 create mode 100644 env-vars/prod.yml
 create mode 100644 env-vars/stage.yml
 create mode 100644 env-vars/uat.yml
 create mode 100644 roles/mysql/.ansible-lint
 create mode 100644 roles/mysql/.github/FUNDING.yml
 
 <truncated>
ubuntu@ip-172-31-62-121:~/ansible-config-mgt$ git status
On branch dynamic-assignments
nothing to commit, working tree clean
ubuntu@ip-172-31-62-121:~/ansible-config-mgt$ git checkout main
Switched to branch 'main'
Your branch is up to date with 'origin/main'.
ubuntu@ip-172-31-62-121:~/ansible-config-mgt$ git status
On branch main
Your branch is up to date with 'origin/main'.

nothing to commit, working tree clean
ubuntu@ip-172-31-62-121:~/ansible-config-mgt$ git merge dynamic-assignments
Updating ab257d6..a9d7825
Fast-forward
 dynamic-assignments/env-vars.yml          |  16 +++++
 env-vars/dev.yml                          |   0
 env-vars/prod.yml                         |   0
 env-vars/stage.yml                        |   0
 env-vars/uat.yml                          |   0
 roles/mysql/.ansible-lint                 |   3 +
 roles/mysql/.github/FUNDING.yml           |   4 ++
 roles/mysql/.github/stale.yml             |  56 ++++++++++++++++++
 
 <truncated>
Total 50 (delta 2), reused 0 (delta 0)
remote: Resolving deltas: 100% (2/2), done.
To https://github.com/thinkC/ansible-config-mgt.git
   ab257d6..a9d7825  main -> main
```

## MySQL Server Role

Create and Configure MySQL instance

1. Create an Ubuntu Server 20.04 and allow  port 22 for SSH
2. Configure the new MySQL server using ansible

1. Create `mysql` role using `ansible-galaxy`

```bash
mkdir roles
cd roles
ansible-galaxy init mysql
```

Add below code to `main.yml` under task in mysql role

```yml
---
- name: Install mySQL and other dependencies
  become: true
  apt:
   name: ['mysql-server', 'python3-pip', 
'libmysqlclient-dev', 'python3-dev', 'python3-mysqldb']
   state: present
   update_cache: True
  

- name: ensure mysql is started and enabled
  become: true
  ansible.builtin.service:
     name: mysql
     state: started 
     enabled: yes

- name: create /var/lib/mysql/mysql.sock
  become: true
  ansible.builtin.file:
    path: /var/lib/mysql/mysql.sock
    state: touch

- name: Create Database
  become: true
  mysql_db: 
   name: tooling
   state: present

- name: Create Application DB user
  become: true
  mysql_user:
   name: webaccess
   password: sePret^i
   host: '172.31.60.208'
   priv: '*.*:ALL,GRANT'
   state: present

- name: update /ect/my.cf for bind-address
  become: true
  ansible.builtin.copy:
   src: /home/ubuntu/downloads/my.cnf.j2
   dest: /etc/mysql/mysql.conf.d/mysqld.cnf
  
- name: restart mysql
  become: true
  ansible.builtin.service:
     name: mysql
     state: started 

- import_tasks: configure-firewall.yml 
```
2. In `static-assignments` create `uat-mysqlserver.yml` and add code below

```yml
---
- hosts: uat-mysqlserver
  roles:
     - mysql
```

Our `playbooks/site.yml` should have below

```yml
- hosts: uat-mysqlserver
- name: MySQL assignment
  import_playbook: ../static-assignments/uat-mysqlserver.yml
```

3. In `inventory/uat` we add entry for the mysql server instance

```yml
[uat-mysqlserver]
172.31.60.208 ansible_ssh_user='ubuntu' ansible_ssh_private_key_file=/home/ubuntu/ansible-config-mgt
```

4. MySQL in roles folder structure should look like below. Under task, create `configure-firewall.yml` and add code below

```yml
- name: install firewalld
  become: true
  ansible.builtin.apt:
     name: firewalld
     state: latest

- name: ensure httpd firewalld is started
  become: true
  ansible.builtin.service:
     name: firewalld
     state: started 
     enabled: yes

- name: permit traffic in public zone for https service
  become: true
  firewalld:
    zone: public
    service: https
    permanent: yes
    state: enabled   

- name: Allow port 8080
  become: true
  firewalld:
    state: enabled
    port: 3306/tcp
    permanent: yes

- name: permit traffic in public zone for http service
  become: true
  #ansible.posix.firewalld:
  firewalld:
    zone: public
    service: http
    permanent: yes
    state: enabled   
  
- name: ensure httpd firewalld is restarted
  become: true
  ansible.builtin.service:
     name: firewalld
     state: restarted
```

5. Create `my.cnf.j` and add code below. This is for mysl binding.

```bash
#
# The MySQL database server configuration file.
#
# One can use all long options that the program supports.
# Run program with --help to get a list of available options and with
# --print-defaults to see which it would actually understand and use.
#
# For explanations see
# http://dev.mysql.com/doc/mysql/en/server-system-variables.html

# Here is entries for some specific programs
# The following values assume you have at least 32M ram

[mysqld]
#
# * Basic Settings
#
user		= mysql
# pid-file	= /var/run/mysqld/mysqld.pid
# socket	= /var/run/mysqld/mysqld.sock
# port		= 3306
# datadir	= /var/lib/mysql


# If MySQL is running as a replication slave, this should be
# changed. Ref https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_tmpdir
# tmpdir		= /tmp
#
# Instead of skip-networking the default is now to listen only on
# localhost which is more compatible and is not less secure.
bind-address		= 0.0.0.0
mysqlx-bind-address	= 0.0.0.0
#
# * Fine Tuning
#
key_buffer_size		= 16M
# max_allowed_packet	= 64M
# thread_stack		= 256K

# thread_cache_size       = -1

# This replaces the startup script and checks MyISAM tables if needed
# the first time they are touched
myisam-recover-options  = BACKUP

# max_connections        = 151

# table_open_cache       = 4000

#
# * Logging and Replication
#
# Both location gets rotated by the cronjob.
#
# Log all queries
# Be aware that this log type is a performance killer.
# general_log_file        = /var/log/mysql/query.log
# general_log             = 1
#
# Error log - should be very few entries.
#
log_error = /var/log/mysql/error.log
#
# Here you can see queries with especially long duration
# slow_query_log		= 1
# slow_query_log_file	= /var/log/mysql/mysql-slow.log
# long_query_time = 2
# log-queries-not-using-indexes
#
# The following can be used as easy to replay backup logs or for replication.
# note: if you are setting up a replication slave, see README.Debian about
#       other settings you may need to change.
# server-id		= 1
# log_bin			= /var/log/mysql/mysql-bin.log
# binlog_expire_logs_seconds	= 2592000
max_binlog_size   = 100M
# binlog_do_db		= include_database_name
# binlog_ignore_db	= include_database_name

```
Folder structure for MySQL role

```tree
ubuntu@ip-172-31-55-57:~/ansible-config-mgt/roles$ tree mysql
mysql
├── README.md
├── defaults
│   └── main.yml
├── handlers
│   └── main.yml
├── meta
│   └── main.yml
├── tasks
│   ├── configure-firewall.yml
│   └── main.yml
├── templates
│   └── my.cnf.j
├── tests
│   ├── inventory
│   └── test.yml
└── vars
    └── main.yml
  
```
6. Commit and Push all changes to GitHub

7. Next run command below to install MySQL and other dependencies and configure it.

```bash
sudo ansible-playbook -i inventory/uat playbooks/site.yml
```

Next we login to MySQL server and check if database is created

```mysql
mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
| tooling            |
+--------------------+
5 rows in set (0.01 sec)

mysql> 
```

## Load Balancer Roles

## Create and Configure Apache Load Balancer

We create Apache - Load Balancer 

```bash
cd roles
ansible-galaxy init apache-lb
```

output

```bash
Role apache-lb was created successfully
```

```bash
ubuntu@ip-172-31-62-121:~/ansible-config-mgt/roles$ ls -l
total 16
drwxrwxr-x 10 ubuntu ubuntu 4096 Jul 20 21:44 apache-lb
drwxrwxr-x 10 ubuntu ubuntu 4096 Jul 20 16:49 mysql
# drwxrwxr-x 10 ubuntu ubuntu 4096 Jul 20 20:50 nginx-old
drwxrwxr-x 10 ubuntu ubuntu 4096 Jul 19 18:47 webserver
```

We have below for apache-lb role

```bash
ubuntu@ip-172-31-55-57:~/ansible-config-mgt/roles$ tree apache-lb/
apache-lb/
├── README.md
├── defaults
│   └── main.yml
├── handlers
│   └── main.yml
├── meta
│   └── main.yml
├── tasks
│   ├── configure-firewall.yml
│   └── main.yml
├── templates
│   └── 000-default.conf.j2
├── tests
│   ├── inventory
│   └── test.yml
└── vars
    └── main.yml

7 directories, 10 files
```

1. Copy below code to main in `apache-lb` role

```yml
--- 


- name: Install apache httpd 
  become: true
  apt:  name=apache2 update_cache=yes state=latest
    
- name: Install libxml2-dev
  become: true
  apt:
    name: libxml2-dev
    state: present


- name: enabled mod_rewrite
  become: true
  apache2_module: name=rewrite state=present


- name: enabled mod_proxy
  become: true
  apache2_module: name=proxy state=present
  
- name: enabled mod_proxy_balancer
  become: true
  apache2_module: name=proxy_balancer state=present

- name: enabled mod_proxy_http
  become: true
  apache2_module: name=proxy_http state=present

- name: enabled mod_headers
  become: true
  apache2_module: name=headers state=present

- name: enabled mod_lbmethod_bytraffic
  become: true
  apache2_module: name=lbmethod_bytraffic state=present

- name: restart apache2
  become: true
  service: name=apache2 state=restarted

- name: Move 000-default.conf to /etc/apache2/sites-available/
  become: yes
  ansible.builtin.copy:
    src: /home/ubuntu/downloads/000-default.conf
    dest: /etc/apache2/sites-available/000-default.conf
    force: yes
- import_tasks: configure-firewall.yml


```
2. Add below to `inventory/uat`

```yml
[uat-apache-loadbalancer]
172.31.57.125 ansible_ssh_user='ubuntu' ansible_ssh_private_key_file=/home/ubuntu/ansible-config-mgt
```
3. Create `uat-apache-loadbalancer.yml` file and add below

```yml 
---
- hosts: uat-apache-loadbalancer
  roles:
     - apache-lb
```
4. Create `configure-firewall.yml` under `roles/tasks` for `apache-lb` and add code below

```yml
- name: install firewalld
  become: true
  ansible.builtin.apt:
     name: firewalld
     state: latest

- name: ensure httpd firewalld is started
  become: true
  ansible.builtin.service:
     name: firewalld
     state: started 
     enabled: yes

- name: permit traffic in public zone for https service
  become: true
  #ansible.posix.firewalld:
  firewalld:
    zone: public
    service: https
    permanent: yes
    state: enabled   

- name: Allow port 80
  become: true
  #ansible.posix.firewalld:
  firewalld:
    state: enabled
    port: 80/tcp
    permanent: yes

- name: permit traffic in public zone for http service
  become: true
  #ansible.posix.firewalld:
  firewalld:
    zone: public
    service: http
    permanent: yes
    state: enabled   
  
- name: ensure httpd firewalld is restarted
  become: true
  ansible.builtin.service:
     name: firewalld
     state: restarted

```

4. Commit and push all changes to GitHub

5. Next run the playbook 

```bash
sudo ansible-playbook -i inventory/uat playbooks/site.yml
```

output

```yml
[DEPRECATION WARNING]: The TRANSFORM_INVALID_GROUP_CHARS settings is set to 
allow bad characters in group names by default, this will change, but still be 
user configurable on deprecation. This feature will be removed in version 2.10.
 Deprecation warnings can be disabled by setting deprecation_warnings=False in 
ansible.cfg.
[WARNING]: Invalid characters were found in group names but not replaced, use
-vvvv to see details

PLAY [uat-apache-loadbalancer] *************************************************

TASK [Gathering Facts] *********************************************************
ok: [172.31.57.125]

PLAY [uat-apache-loadbalancer] *************************************************

TASK [Gathering Facts] *********************************************************
ok: [172.31.57.125]

TASK [apache-lb : Install apache httpd] ****************************************
changed: [172.31.57.125]

TASK [apache-lb : Install libxml2-dev] *****************************************
changed: [172.31.57.125]

TASK [apache-lb : enabled mod_rewrite] *****************************************
changed: [172.31.57.125]

TASK [apache-lb : enabled mod_proxy] *******************************************
changed: [172.31.57.125]

TASK [apache-lb : enabled mod_proxy_balancer] **********************************
changed: [172.31.57.125]

TASK [apache-lb : enabled mod_proxy_http] **************************************
changed: [172.31.57.125]

TASK [apache-lb : enabled mod_headers] *****************************************
changed: [172.31.57.125]

TASK [apache-lb : enabled mod_lbmethod_bytraffic] ******************************
changed: [172.31.57.125]

TASK [apache-lb : restart apache2] ***********************************************
changed: [172.31.57.125]

TASK [apache-lb : Move 000-default.conf to /etc/apache2/sites-available/] ********
changed: [172.31.57.125]

TASK [apache-lb : restart apache2] ***********************************************
changed: [172.31.57.125]

TASK [apache-lb : install firewalld] *********************************************
changed: [172.31.57.125]

TASK [apache-lb : ensure httpd firewalld is started] *****************************
ok: [172.31.57.125]

TASK [apache-lb : permit traffic in public zone for https service] ***************
changed: [172.31.57.125]

TASK [apache-lb : Allow port 80] *************************************************
changed: [172.31.57.125]

TASK [apache-lb : permit traffic in public zone for http service] ****************
changed: [172.31.57.125]

TASK [apache-lb : ensure httpd firewalld is restarted] ***************************
changed: [172.31.57.125]

PLAY RECAP ***********************************************************************
172.31.57.125              : ok=19   changed=7    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0    
```

**Note**

I got error below that could to access or locate my template in my roles. I could not fix it so I created a `my.cnf.j` in `/home/ubuntu/downloads/my.cnf.j2` and used `copy` module .Formally I had it as below using template in main.yml for mysql role.

```yml
# - name: update /ect/my.cf for bind-address
#   become: true
#   template:
#     src: templates/my.cnf.j2
#     dest: /etc/mysql/mysql.conf.d/mysqld.cnf
#   notify: Restart mysql
```

```bash
fatal: [172.31.60.208]: FAILED! => {"changed": false, "msg": "Could not find or access 'templates/my.cnf.j2'\nSearched in:\n\t/home/ubuntu/ansible-config-mgt/roles/mysql/templates/templates/my.cnf.j2\n\t/home/ubuntu/ansible-config-mgt/roles/mysql/templates/my.cnf.j2\n\t/home/ubuntu/ansible-config-mgt/roles/mysql/tasks/templates/templates/my.cnf.j2\n\t/home/ubuntu/ansible-config-mgt/roles/mysql/tasks/templates/my.cnf.j2\n\t/home/ubuntu/ansible-config-mgt/playbooks/../static-assignments/templates/templates/my.cnf.j2\n\t/home/ubuntu/ansible-config-mgt/playbooks/../static-assignments/templates/my.cnf.j2 on the Ansible Controller.\nIf you are using a module and expect the file to exist on the remote, see the remote_src option"}
```

output

```yml
[DEPRECATION WARNING]: The TRANSFORM_INVALID_GROUP_CHARS settings is set to allow 
bad characters in group names by default, this will change, but still be user 
configurable on deprecation. This feature will be removed in version 2.10. 
Deprecation warnings can be disabled by setting deprecation_warnings=False in 
ansible.cfg.
[WARNING]: Invalid characters were found in group names but not replaced, use -vvvv
to see details

PLAY [uat-mysqlserver] **************************************************************

TASK [Gathering Facts] **************************************************************
ok: [172.31.60.208]

PLAY [uat-mysqlserver] **************************************************************

TASK [Gathering Facts] **************************************************************
ok: [172.31.60.208]

TASK [mysql : Install mySQL] ********************************************************

changed: [172.31.60.208]

TASK [mysql : ensure mysql is started and enabled] **********************************
ok: [172.31.60.208]

TASK [mysql : create /var/lib/mysql/mysql.sock] *************************************
changed: [172.31.60.208]


TASK [mysql : Install mySQL and other dependencies] *********************************
changed: [172.31.60.208]

TASK [mysql : ensure mysql is started and enabled] **********************************
ok: [172.31.60.208]

TASK [mysql : create /var/lib/mysql/mysql.sock] *************************************
changed: [172.31.60.208]

TASK [mysql : create /var/lib/mysql/mysql.sock] **********************************
changed: [172.31.60.208]

TASK [mysql : Create Database] ***************************************************
ok: [172.31.60.208]

TASK [mysql : Create Application DB user] ****************************************
[WARNING]: Module did not set no_log for update_password
changed: [172.31.60.208]

TASK [mysql : update /ect/my.cf for bind-address] ********************************
ok: [172.31.60.208]

TASK [mysql : restart mysql] *****************************************************
ok: [172.31.60.208]

TASK [mysql : install firewalld] *************************************************
ok: [172.31.60.208]

TASK [mysql : ensure httpd firewalld is started] *********************************
ok: [172.31.60.208]

TASK [mysql : permit traffic in public zone for https service] *******************
ok: [172.31.60.208]

TASK [mysql : Allow port 8080] ***************************************************
ok: [172.31.60.208]

TASK [mysql : permit traffic in public zone for http service] ********************
ok: [172.31.60.208]

TASK [mysql : ensure httpd firewalld is restarted] *******************************
changed: [172.31.60.208]
ERROR! the field 'hosts' is required but was not set

```

**Note** - Even though I installed firewalld and allowed port 80 for public, it was not added in AWS. I had to add it manually. I will like to know why it did not work.

As seen below we now test to see if we can browse the website on the tooling website using the public Ip address of the apache load balancer.

```bash
http://3.86.7.10/index.php
```

![apache-lb](https://github.com/thinkC/devops-projects/blob/master/img-ansible1/img6.PNG?raw=true)

Checking `Web1-UAT` and `Web2-UAT` access log, we see the traffic coming from both servers and being distributed by the Apache load balancer.

![apache-lb](https://github.com/thinkC/devops-projects/blob/master/img-ansible1/img3.PNG?raw=true)

![apache-lb](https://github.com/thinkC/devops-projects/blob/master/img-ansible1/img4.PNG?raw=true)


## Create and Configure Nginx Load Balancer

Our folder structure for nginx-lb in roles folder will look like below

```bash
ubuntu@ip-172-31-55-57:~/ansible-config-mgt/roles$ tree nginx-lb/
nginx-lb/
├── README.md
├── defaults
│   └── main.yml
├── handlers
│   └── main.yml
├── meta
│   └── main.yml
├── tasks
│   └── main.yml
├── tests
│   ├── inventory
│   └── test.yml
└── vars
    └── main.yml

6 directories, 8 files
```

Next on our Ansible-Jenkins server , we create `nginx-lb` in roles folder

```bash
cd roles
 ansible-galaxy install nginx-lb
```

We add code below to main in roles for for `nginx-lb`.

```yml
--- 
- name: Install nginx
  become: true
  apt:  name=nginx update_cache=yes state=latest
    
- name: restart and enable nginx
  become: true
  ansible.builtin.service:
   name: nginx 
   state: started 
   enabled: yes

- name: copy load_balancer.conf file
  become: true
  ansible.builtin.copy:
   src: /home/ubuntu/ansible-config-mgt/downloads/load_balancer.conf
   dest: /etc/nginx/sites-available/

- name: Remove default site
  become: true
  ansible.builtin.file:
   path: /etc/nginx/sites-enabled/default
   state: absent
 

- name: linking load_balancer.conf file to sites enabled
  become: true
  ansible.builtin.file:
   src: /etc/nginx/sites-available
   dest: /etc/nginx/sites-enabled
   state: link

  
- name: restart nginx
  become: true
  service: name=nginx state=restarted

```

**Note** I could not add instruction to link my load_balancer.conf file in sites-available to sites-enabled with ansible, so I linked it manually as below

```bash
ubuntu@ip-172-31-63-175:/etc/nginx/sites-enabled$ sudo ln -s ../sites-available/load_balancer.conf 
ubuntu@ip-172-31-63-175:/etc/nginx/sites-enabled$ ll
total 8
drwxr-xr-x 2 root root 4096 Jul 28 20:14 ./
drwxr-xr-x 8 root root 4096 Jul 28 18:00 ../
lrwxrwxrwx 1 root root   37 Jul 28 20:14 load_balancer.conf -> ../sites-available/load_balancer.conf
```

Add below to `inventory/uat-dev`

```yml
[uat-nginx-loadbalancer]
172.31.63.175 ansible_ssh_user='ubuntu' ansible_ssh_private_key_file=/home/ubuntu/ansible-config-mgt
```

Add below to `playbooks/site.yml`

```yml
- hosts: uat-nginx-loadbalancer
- name: Nginx Load Balancer Assignment
  import_playbook: ../static-assignments/uat-nginx-loadbalancer.yml

```

Create `uat-nginx-loadbalancer.yml` in `static-assignments` folder and add code below.

```bash
---
- hosts: uat-nginx-loadbalancer
  roles:
     - nginx-lb
```

Next, we run code below to run the ansible playbook.

```bash
sudo ansible-playbook -i inventory/uat playbooks/site.yml
```

output

```yml
[DEPRECATION WARNING]: The TRANSFORM_INVALID_GROUP_CHARS settings is set to 
allow bad characters in group names by default, this will change, but still be 
user configurable on deprecation. This feature will be removed in version 2.10.
 Deprecation warnings can be disabled by setting deprecation_warnings=False in 
ansible.cfg.
[WARNING]: Invalid characters were found in group names but not replaced, use
-vvvv to see details

PLAY [uat-nginx-loadbalancer] **************************************************

TASK [Gathering Facts] *********************************************************
ok: [172.31.63.175]

PLAY [uat-nginx-loadbalancer] **************************************************

TASK [Gathering Facts] *********************************************************
ok: [172.31.63.175]

TASK [nginx-lb : Install nginx] ************************************************

changed: [172.31.63.175]

TASK [nginx-lb : restart and enable nginx] *************************************
ok: [172.31.63.175]

PLAY RECAP *********************************************************************
TASK [nginx-lb : copy load_balancer.conf file] *******************************************************
changed: [172.31.63.175]

PLAY RECAP *******************************************************************************************
172.31.63.175              : ok=5    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 
```


Now, we test if Nginx load balancing is working. We broswe the Nginx load balancer with teh public IP

![nginx-loadbalancer](https://github.com/thinkC/devops-projects/blob/master/img-ansible1/img9.PNG?raw=true)

Checking `Web1-UAT` and `Web2-UAT` access log, we see the traffic coming from both servers and being distributed by the Nginx load balancer.

![nginx-loadbalancer](https://github.com/thinkC/devops-projects/blob/master/img-ansible1/img10-nginx.PNG?raw=true)

![nginx-loadbalancer](https://github.com/thinkC/devops-projects/blob/master/img-ansible1/img11-nginx.PNG?raw=true)

## Create condition to choose Load Balancers

Our site.yml should now look like this

```yml
---
- hosts: all
- name: Include dynamic variables 
  tasks:
- name: Testing
  import_playbook: ../dynamic-assignments/env-vars.yml
  tags:
    - always

-  hosts: uat-webservers
- name: Webserver assignment
  import_playbook: ../static-assignments/uat-webservers.yml


- hosts: uat-mysqlserver
- name: MySQL assignment
  import_playbook: ../static-assignments/uat-mysqlserver.yml

- hosts: uat-apache-loadbalancer
- name: Apache Load Balancer Assignment
  import_playbook: ../static-assignments/uat-apache-loadbalancer.yml

- hosts: uat-nginx-loadbalancer
- name: Nginx Load Balancer Assignment
  import_playbook: ../static-assignments/uat-nginx-loadbalancer.yml

```

Now we have both **Nginx** and **Apache** running we need to setup a condition where we can choose either we will make use of variables.

1. Declare a variable in `defaults/main.yml` file inside the Nginx and Apache roles and name each variable `enable_nginx_lb` and `enable_apache_lb`.
2. Set both values to false like this `enable_nginx_lb: false` and `enable_apache_lb: false`.
3. Declare another variable in both roles `load_balancer_is_required` and set its value to `false` as well.
4. Update both assignment and `site.yml` files respectively

Our `loadbalancers.yml` should have command below

```yml
# - hosts: lb
#   roles:
#     - role: nginx, when: enable_nginx_lb and load_balancer_is_required
#     - role: apache, when: enable_apache_lb and load_balancer_is_required

- hosts: lb
  roles:
   - role: nginx
     when: enable_nginx_lb and load_balancer_is_required
   - role: apache
     when: enable_apache_lb and load_balancer_is_required
```

We update `site.yml` with below

```yml
# - name: Loadbalancers assignment
#        hosts: lb
#          - import_playbook: ../static-assignments/loadbalancers.yml
#         when: load_balancer_is_required 

- hosts: lb
- name: Loadbalancers assignment
  import_playbook: ../static-assignments/loadbalancers.yml
  when: load_balancer_is_required 

```

Now we can make use of `env-vars\uat.yml` file to define which loadbalancer to use in UAT environment by setting respective environmental variable to true.

We will activate load balancer, and enable nginx by setting these in the respective environment’s env-vars file.

```yml
enable_nginx_lb: true
load_balancer_is_required: true
```

The same must work with `apache LB`, so you can switch it by setting respective environmental variable to true and other to false.

To test this, you can update inventory for each environment and run Ansible against each environment.

**Note** Had issue using dynamic variable with both load balancers.
Awaiting a solution for this.
