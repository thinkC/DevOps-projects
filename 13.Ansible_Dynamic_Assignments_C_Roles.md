

## Introducing Ansible Dynamic Assignment Into Our Structure

We start by creating a new branch in our `https://github.com/thinkC/ansible-config-mgt` repository , we name the branch `dynamic-assignments`.

```bash
git checkout -b dynamic-assignments
```
output

```bash
Switched to a new branch 'dynamic-assignments'
```

Next we create folder `dynamic-assignments`

```bash
mkdir dynamic-assignments
````

output

```
ubuntu@ip-172-31-62-121:~/ansible-config-mgt$ ls -l
total 28
-rw-rw-r-- 1 ubuntu ubuntu   74 Jul 19 15:55 README.md
drwxrwxr-x 3 ubuntu ubuntu 4096 Jul 16 20:47 ansible-config-mgt
drwxrwxr-x 2 ubuntu ubuntu 4096 Jul 20 15:40 dynamic-assignments
drwxrwxr-x 2 ubuntu ubuntu 4096 Jul 17 10:50 inventory
drwxrwxr-x 2 ubuntu ubuntu 4096 Jul 19 15:11 playbooks
drwxrwxr-x 3 ubuntu ubuntu 4096 Jul 19 18:47 roles
drwxrwxr-x 2 ubuntu ubuntu 4096 Jul 19 20:08 static-assignments
```

Next, we will create a folder named `env-vars` to keep each of our environment variable file. Then, we create new YAML file which will be used to set the variables.

```bash
mkdir env-vars
cd env-vars
touch dev.yml stage.yml uat.yml prod.yml
```


output

```bash
ubuntu@ip-172-31-62-121:~/ansible-config-mgt/env-vars$ ls -l
total 0
-rw-rw-r-- 1 ubuntu ubuntu 0 Jul 20 16:03 dev.yml
-rw-rw-r-- 1 ubuntu ubuntu 0 Jul 20 16:03 prod.yml
-rw-rw-r-- 1 ubuntu ubuntu 0 Jul 20 16:03 stage.yml
-rw-rw-r-- 1 ubuntu ubuntu 0 Jul 20 16:03 uat.yml
ubuntu@ip-172-31-62-121:~/ansible-config-mgt/env-vars$ 
```

Our folder structure should look like this

![folder layout](./img-ansible1/img1.png)

Next we paste intruction below in to the `env-vars.yml`
```yml
---
- name: collate variables from env specific file, if it exists
  hosts: all
  tasks:
    - name: looping through list of available files
      include_vars: "{{ item }}"
      with_first_found:
        - files:
            - dev.yml
            - stage.yml
            - prod.yml
            - uat.yml
          paths:
            - "{{ playbook_dir }}/../env-vars"
      tags:
        - always
```

<!-- Reason for the yaml code above here -->

Reason for the yaml code above here ...

Next, we create a new MySQL role inside `roles` directory with ` ansible-galaxy install geerlingguy.mysql` and rename it to `myswl`.

```bash
cd roles
```

```bash
 ansible-galaxy install geerlingguy.mysql
 ```

 output

 ```bash
 - downloading role 'mysql', owned by geerlingguy
- downloading role from https://github.com/geerlingguy/ansible-role-mysql/archive/3.3.2.tar.gz
- extracting geerlingguy.mysql to /home/ubuntu/ansible-config-mgt/roles/geerlingguy.mysql
- geerlingguy.mysql (3.3.2) was installed successfully
```

 ```bash
 mv geerlingguy.mysql/ mysql
 ```

 output

 ```bash
 ubuntu@ip-172-31-62-121:~/ansible-config-mgt/roles$ mv geerlingguy.mysql/ mysql
ubuntu@ip-172-31-62-121:~/ansible-config-mgt/roles$ ls -l
total 8
drwxrwxr-x 10 ubuntu ubuntu 4096 Jul 20 16:35 mysql
drwxrwxr-x 10 ubuntu ubuntu 4096 Jul 19 18:47 webserver
```
## Update Site.yml With Dynamic Assignment

Next we update `site.yml` with dynamic assignment

```yml
---
- hosts: all
- name: Include dynamic variables 
  tasks:
  import_playbook: ../static-assignments/common.yml 
  include: ../dynamic-assignments/env-vars.yml
  tags:
    - always

-  hosts: webservers
- name: Webserver assignment
  import_playbook: ../static-assignments/webservers.yml
```

Next, we we read the README.md file in `roles/mysql/README.md` and edit roles configuration so as to use correct credentials for MySQL required for the tooling website.

<!-- We will need to update below
172.31.49.116
webaccess
passwd- tooling -->

Next we commit all our changes our `dynamic-assignments` branch and merge it with our main branch. We then push to our `ansible-config-mgt` repository.

output
```bash
ubuntu@ip-172-31-62-121:~/ansible-config-mgt$ git status
On branch dynamic-assignments
Untracked files:
  (use "git add <file>..." to include in what will be committed)
        dynamic-assignments/
        env-vars/
        roles/mysql/

nothing added to commit but untracked files present (use "git add" to track)
ubuntu@ip-172-31-62-121:~/ansible-config-mgt$ git add .

ubuntu@ip-172-31-62-121:~/ansible-config-mgt$ git commit -m "added new roles"
[dynamic-assignments a9d7825] added new roles
 Committer: Ubuntu <ubuntu@ip-172-31-62-121.ec2.internal>
Your name and email address were configured automatically based
on your username and hostname. Please check that they are accurate.
You can suppress this message by setting them explicitly. Run the
following command and follow the instructions in your editor to edit
your configuration file:

    git config --global --edit

After doing this, you may fix the identity used for this commit with:

    git commit --amend --reset-author

 38 files changed, 1219 insertions(+)
 create mode 100644 dynamic-assignments/env-vars.yml
 create mode 100644 env-vars/dev.yml
 create mode 100644 env-vars/prod.yml
 create mode 100644 env-vars/stage.yml
 create mode 100644 env-vars/uat.yml
 create mode 100644 roles/mysql/.ansible-lint
 create mode 100644 roles/mysql/.github/FUNDING.yml
 create mode 100644 roles/mysql/.github/stale.yml
 create mode 100644 roles/mysql/.github/workflows/ci.yml
 create mode 100644 roles/mysql/.github/workflows/release.yml
 create mode 100644 roles/mysql/.gitignore
 create mode 100644 roles/mysql/.yamllint
 create mode 100644 roles/mysql/LICENSE
 create mode 100644 roles/mysql/README.md
 create mode 100644 roles/mysql/defaults/main.yml
 create mode 100644 roles/mysql/handlers/main.yml
 create mode 100644 roles/mysql/meta/.galaxy_install_info
 create mode 100644 roles/mysql/meta/main.yml
 create mode 100644 roles/mysql/molecule/default/converge.yml
 create mode 100644 roles/mysql/molecule/default/molecule.yml
 create mode 100644 roles/mysql/tasks/configure.yml
 create mode 100644 roles/mysql/tasks/databases.yml
 create mode 100644 roles/mysql/tasks/main.yml
 create mode 100644 roles/mysql/tasks/replication.yml
 create mode 100644 roles/mysql/tasks/secure-installation.yml
 create mode 100644 roles/mysql/tasks/setup-Archlinux.yml
 create mode 100644 roles/mysql/tasks/setup-Debian.yml
 create mode 100644 roles/mysql/tasks/setup-RedHat.yml
 create mode 100644 roles/mysql/tasks/users.yml
 create mode 100644 roles/mysql/tasks/variables.yml
 create mode 100644 roles/mysql/templates/my.cnf.j2
 create mode 100644 roles/mysql/templates/root-my.cnf.j2
 create mode 100644 roles/mysql/templates/user-my.cnf.j2
 create mode 100644 roles/mysql/vars/Archlinux.yml
 create mode 100644 roles/mysql/vars/Debian-10.yml
 create mode 100644 roles/mysql/vars/Debian.yml
 create mode 100644 roles/mysql/vars/RedHat-7.yml
 create mode 100644 roles/mysql/vars/RedHat-8.yml
ubuntu@ip-172-31-62-121:~/ansible-config-mgt$ git status
On branch dynamic-assignments
nothing to commit, working tree clean
ubuntu@ip-172-31-62-121:~/ansible-config-mgt$ git checkout main
Switched to branch 'main'
Your branch is up to date with 'origin/main'.
ubuntu@ip-172-31-62-121:~/ansible-config-mgt$ git status
On branch main
Your branch is up to date with 'origin/main'.

nothing to commit, working tree clean
ubuntu@ip-172-31-62-121:~/ansible-config-mgt$ git merge dynamic-assignments
Updating ab257d6..a9d7825
Fast-forward
 dynamic-assignments/env-vars.yml          |  16 +++++
 env-vars/dev.yml                          |   0
 env-vars/prod.yml                         |   0
 env-vars/stage.yml                        |   0
 env-vars/uat.yml                          |   0
 roles/mysql/.ansible-lint                 |   3 +
 roles/mysql/.github/FUNDING.yml           |   4 ++
 roles/mysql/.github/stale.yml             |  56 ++++++++++++++++++
 roles/mysql/.github/workflows/ci.yml      |  77 ++++++++++++++++++++++++
 roles/mysql/.github/workflows/release.yml |  38 ++++++++++++
 roles/mysql/.gitignore                    |   4 ++
 roles/mysql/.yamllint                     |  10 ++++
 roles/mysql/LICENSE                       |  20 +++++++
 roles/mysql/README.md                     | 199 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 roles/mysql/defaults/main.yml             | 130 ++++++++++++++++++++++++++++++++++++++++
 roles/mysql/handlers/main.yml             |   3 +
 roles/mysql/meta/.galaxy_install_info     |   2 +
 roles/mysql/meta/main.yml                 |  30 ++++++++++
 roles/mysql/molecule/default/converge.yml |  16 +++++
 roles/mysql/molecule/default/molecule.yml |  17 ++++++
 roles/mysql/tasks/configure.yml           |  87 +++++++++++++++++++++++++++
 roles/mysql/tasks/databases.yml           |   8 +++
 roles/mysql/tasks/main.yml                |  26 ++++++++
 roles/mysql/tasks/replication.yml         |  58 ++++++++++++++++++
 roles/mysql/tasks/secure-installation.yml |  86 +++++++++++++++++++++++++++
 roles/mysql/tasks/setup-Archlinux.yml     |  12 ++++
 roles/mysql/tasks/setup-Debian.yml        |  32 ++++++++++
 roles/mysql/tasks/setup-RedHat.yml        |   7 +++
 roles/mysql/tasks/users.yml               |  12 ++++
 roles/mysql/tasks/variables.yml           |  59 +++++++++++++++++++
 roles/mysql/templates/my.cnf.j2           | 124 +++++++++++++++++++++++++++++++++++++++
 roles/mysql/templates/root-my.cnf.j2      |   5 ++
 roles/mysql/templates/user-my.cnf.j2      |   5 ++
 roles/mysql/vars/Archlinux.yml            |  12 ++++
 roles/mysql/vars/Debian-10.yml            |  13 ++++
 roles/mysql/vars/Debian.yml               |  14 +++++
 roles/mysql/vars/RedHat-7.yml             |  16 +++++
 roles/mysql/vars/RedHat-8.yml             |  18 ++++++
 38 files changed, 1219 insertions(+)
 create mode 100644 dynamic-assignments/env-vars.yml
 create mode 100644 env-vars/dev.yml
 create mode 100644 env-vars/prod.yml
 create mode 100644 env-vars/stage.yml
 create mode 100644 env-vars/uat.yml
 create mode 100644 roles/mysql/.ansible-lint
 create mode 100644 roles/mysql/.github/FUNDING.yml
 create mode 100644 roles/mysql/.github/stale.yml
 create mode 100644 roles/mysql/.github/workflows/ci.yml
 create mode 100644 roles/mysql/.github/workflows/release.yml
 create mode 100644 roles/mysql/.gitignore
 create mode 100644 roles/mysql/.yamllint
 create mode 100644 roles/mysql/LICENSE
 create mode 100644 roles/mysql/README.md
 create mode 100644 roles/mysql/defaults/main.yml
 create mode 100644 roles/mysql/handlers/main.yml
 create mode 100644 roles/mysql/meta/.galaxy_install_info
 create mode 100644 roles/mysql/meta/main.yml
 create mode 100644 roles/mysql/molecule/default/converge.yml
 create mode 100644 roles/mysql/molecule/default/molecule.yml
 create mode 100644 roles/mysql/tasks/configure.yml
 create mode 100644 roles/mysql/tasks/databases.yml
 create mode 100644 roles/mysql/tasks/main.yml
 create mode 100644 roles/mysql/tasks/replication.yml
 create mode 100644 roles/mysql/tasks/secure-installation.yml
 create mode 100644 roles/mysql/tasks/setup-Archlinux.yml
 create mode 100644 roles/mysql/tasks/setup-Debian.yml
 create mode 100644 roles/mysql/tasks/setup-RedHat.yml
 create mode 100644 roles/mysql/tasks/users.yml
 create mode 100644 roles/mysql/tasks/variables.yml
 create mode 100644 roles/mysql/templates/my.cnf.j2
 create mode 100644 roles/mysql/templates/root-my.cnf.j2
 create mode 100644 roles/mysql/templates/user-my.cnf.j2
 create mode 100644 roles/mysql/vars/Archlinux.yml
 create mode 100644 roles/mysql/vars/Debian-10.yml
 create mode 100644 roles/mysql/vars/Debian.yml
 create mode 100644 roles/mysql/vars/RedHat-7.yml
 create mode 100644 roles/mysql/vars/RedHat-8.yml
ubuntu@ip-172-31-62-121:~/ansible-config-mgt$ git push
Enumerating objects: 52, done.
Counting objects: 100% (52/52), done.
Compressing objects: 100% (44/44), done.
Writing objects: 100% (50/50), 17.21 KiB | 734.00 KiB/s, done.
Total 50 (delta 2), reused 0 (delta 0)
remote: Resolving deltas: 100% (2/2), done.
To https://github.com/thinkC/ansible-config-mgt.git
   ab257d6..a9d7825  main -> main
```

## Load Balancer Roles