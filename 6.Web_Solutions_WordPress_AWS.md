# Implementing Web Solutions with Wordpress on AWS

This project involves creating storage infrastructures on two Linux servers and implementing web solutions using [Wordpress](https://en.wikipedia.org/wiki/WordPress) . Wordpress is a free and open-source content management system written in PHP and paired with MySQL or MariaDB as its backend Relational Database Management System (RDBMS).

Our setup will include:
1. A PC that servers as client
2. A Linux server where we will install wordpress
3. A Linux server that will serve as a database

Note our Linux servers will be hosted on Amaon AWS EC2.

We start by creating an _EC2_ server on AWS and name it _Web Server_.

Our Linux server that will be creating is _Amazon Linux 2 AMI_

![Linux](https://github.com/thinkC/devops-projects/blob/master/img-web-wordpress/img1.PNG?raw=true)

Choose a t2 micros
![Linux](https://github.com/thinkC/devops-projects/blob/master/img-web-wordpress/img2.PNG?raw=true)

Give a Tag name of web server
![Linux](https://github.com/thinkC/devops-projects/blob/master/img-web-wordpress/img3.PNG?raw=true)

Create a security group named web-worpress-sg and allow SSH on port 22.
![Linux](https://github.com/thinkC/devops-projects/blob/master/img-web-wordpress/img4.PNG?raw=true)

Review instance
![Linux](https://github.com/thinkC/devops-projects/blob/master/img-web-wordpress/img5.PNG?raw=true)

Select SSH key to use to connect.
![Linux](https://github.com/thinkC/devops-projects/blob/master/img-web-wordpress/img6.PNG?raw=true)

Web server created and running.
![Linux](https://github.com/thinkC/devops-projects/blob/master/img-web-wordpress/img7.PNG?raw=true)

### Attach EBS (Elastic Block Storage) Volumes
Next, we create 3 volumes and add to our _Web Server_.

Click on Volume on _Elastic Block Store_ .

![EBS](https://github.com/thinkC/devops-projects/blob/master/img-web-wordpress/img8.PNG?raw=true)


Click create volume, change size to 10GB, and choose availability zone that is same location with the server . We will repeat this step of creating volumes two more times to create 3 volumes.

![EBS](https://github.com/thinkC/devops-projects/blob/master/img-web-wordpress/img8a.PNG?raw=true)

Choose the new VM _Web Server_ and click attach
![EBS](https://github.com/thinkC/devops-projects/blob/master/img-web-wordpress/img8b.PNG?raw=true)
![EBS](https://github.com/thinkC/devops-projects/blob/master/img-web-wordpress/img9.PNG?raw=true)

Next connect to the VM server _web server_ with ssh

```bash
ssh -i C:\Users\user1\Desktop\Downloads\mysingular-EC2.pem ec2-user@52.23.233.125
```
List all blcok to see if it is listed.

```bash
lsblk
```
output

```bash
NAME    MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
xvda    202:0    0   8G  0 disk
└─xvda1 202:1    0   8G  0 part /
xvdf    202:80   0  10G  0 disk
xvdg    202:96   0  10G  0 disk
xvdh    202:112  0  10G  0 disk
```
They are listed as _xvdf_, _xvdg_, _xvdh_ .

Next, we run `df -h` to see all the mounts and free space on the web server

 output
```bash
Filesystem      Size  Used Avail Use% Mounted on
devtmpfs        482M     0  482M   0% /dev
tmpfs           492M     0  492M   0% /dev/shm
tmpfs           492M  476K  492M   1% /run
tmpfs           492M     0  492M   0% /sys/fs/cgroup
/dev/xvda1      8.0G  1.5G  6.6G  18% /
tmpfs            99M     0   99M   0% /run/user/1000
tmpfs            99M     0   99M   0% /run/user/0
```
Next, we create a single partition on each of the 3 disks.

```bash
sudo gdisk /dev/xvdf
sudo gdisk /dev/xvdg
sudo gdisk /dev/xvdh
```

output

```bash
GPT fdisk (gdisk) version 0.8.10

Partition table scan:
  MBR: not present
  BSD: not present
  APM: not present
  GPT: not present

Creating new GPT entries.

Command (? for help): 
```
Typing '?' shows the menus. Her

```bash
Command (? for help): ?
b       back up GPT data to a file
c       change a partition's name
d       delete a partition
i       show detailed information on a partition
l       list known partition types
n       add a new partition
o       create a new empty GUID partition table (GPT)
p       print the partition table
q       quit without saving changes
r       recovery and transformation options (experts only)
s       sort partitions
t       change a partition's type code
v       verify disk
w       write table to disk and exit
x       extra functionality (experts only)
?       print this menu

Command (? for help): 
```

We choose 'n' to create new Partition.

output

```bash
Command (? for help): n
Partition number (1-128, default 1):
First sector (34-20971486, default = 2048) or {+-}size{KMGTP}:
Last sector (2048-20971486, default = 20971486) or {+-}size{KMGTP}:
Current type is 'Linux filesystem'
```

Type 'l'small 'l' or big 'L' to show codes

output
```bash
Hex code or GUID (L to show codes, Enter = 8300): l
0700 Microsoft basic data  0c01 Microsoft reserved    2700 Windows RE
3000 ONIE boot             3001 ONIE config           4100 PowerPC PReP boot
4200 Windows LDM data      4201 Windows LDM metadata  7501 IBM GPFS
7f00 ChromeOS kernel       7f01 ChromeOS root         7f02 ChromeOS reserved
8200 Linux swap            8300 Linux filesystem      8301 Linux reserved
8302 Linux /home           8400 Intel Rapid Start     8e00 Linux LVM
a500 FreeBSD disklabel     a501 FreeBSD boot          a502 FreeBSD swap
a503 FreeBSD UFS           a504 FreeBSD ZFS           a505 FreeBSD Vinum/RAID
a580 Midnight BSD data     a581 Midnight BSD boot     a582 Midnight BSD swap
a583 Midnight BSD UFS      a584 Midnight BSD ZFS      a585 Midnight BSD Vinum
a800 Apple UFS             a901 NetBSD swap           a902 NetBSD FFS
a903 NetBSD LFS            a904 NetBSD concatenated   a905 NetBSD encrypted
a906 NetBSD RAID           ab00 Apple boot            af00 Apple HFS/HFS+
af01 Apple RAID            af02 Apple RAID offline    af03 Apple label
af04 AppleTV recovery      af05 Apple Core Storage    be00 Solaris boot
bf00 Solaris root          bf01 Solaris /usr & Mac Z  bf02 Solaris swap
bf03 Solaris backup        bf04 Solaris /var          bf05 Solaris /home
bf06 Solaris alternate se  bf07 Solaris Reserved 1    bf08 Solaris Reserved 2
bf09 Solaris Reserved 3    bf0a Solaris Reserved 4    bf0b Solaris Reserved 5
c001 HP-UX data            c002 HP-UX service         ea00 Freedesktop $BOOT
eb00 Haiku BFS             ed00 Sony system partitio  ed01 Lenovo system partit
Press the <Enter> key to see more codes:
ef00 EFI System            ef01 MBR partition scheme  ef02 BIOS boot partition
fb00 VMWare VMFS           fb01 VMWare reserved       fc00 VMWare kcore crash p
fd00 Linux RAID           
```
Type _8e00_ to choose Linux LVM

```bash
Hex code or GUID (L to show codes, Enter = 8300): 8e00
Changed type of partition to 'Linux LVM'

Command (? for help): p
Disk /dev/xvdf: 20971520 sectors, 10.0 GiB
Logical sector size: 512 bytes
Disk identifier (GUID): A7345FC4-B5D7-45FE-B76E-55FCFE1BDB26
Partition table holds up to 128 entries
First usable sector is 34, last usable sector is 20971486
Partitions will be aligned on 2048-sector boundaries
Total free space is 2014 sectors (1007.0 KiB)

Number  Start (sector)    End (sector)  Size       Code  Name
   1            2048        20971486   10.0 GiB    8E00  Linux LVM

Command (? for help): 
```
Type 'w' to write and 'Y' tp proceed.

```bash
Command (? for help): w

Final checks complete. About to write GPT data. THIS WILL OVERWRITE EXISTING
PARTITIONS!!

Do you want to proceed? (Y/N): Y
OK; writing new GUID partition table (GPT) to /dev/xvdf.
The operation has completed successfully.
```

Do the same procedure for other two disks

Run command below to view the newly configured partition on each of the 3 disks

```bash
lsblk
```

output

```bash
NAME    MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
xvda    202:0    0   8G  0 disk
└─xvda1 202:1    0   8G  0 part /
xvdf    202:80   0  10G  0 disk
└─xvdf1 202:81   0  10G  0 part
xvdg    202:96   0  10G  0 disk
└─xvdg1 202:97   0  10G  0 part
xvdh    202:112  0  10G  0 disk
└─xvdh1 202:113  0  10G  0 part
```

Next we install `lvm2` to check available partitions.

```bash 
sudo yum install lvm2
```

Next, we do the following to create a _Logical Volume_

1. Run _pvcreate_ utility to mark each 3 disks as a physical volume (PVs)

```bash
sudo pvcreate /dev/xvdf1
sudo pvcreate /dev/xvdg1
sudo pvcreate /dev/xvdh1
```

output

```bash
[ec2-user@ip-172-31-88-7 ~]$ sudo pvcreate /dev/xvdf1
  Physical volume "/dev/xvdf1" successfully created.
[ec2-user@ip-172-31-88-7 ~]$ sudo pvcreate /dev/xvdg1
  Physical volume "/dev/xvdg1" successfully created.
[ec2-user@ip-172-31-88-7 ~]$ sudo pvcreate /dev/xvdh1
  Physical volume "/dev/xvdh1" successfully created.
```

2. Verify our Physical volume is created

```bash
sudo pvs
```

output

```bash
/dev/sdf1     lvm2 ---  <10.00g <10.00g
/dev/sdg1     lvm2 ---  <10.00g <10.00g
/dev/sdh1     lvm2 ---  <10.00g <10.00g
```

3. Use `vgcreate` utility to add all 3 Physocal Volumes to a Volume group (VG) , name the VG as _webdata-vg_ .

```bash
sudo vgcreate webdata-vg /dev/xvdh1 /dev/xvdg1 /dev/xvdf1
```

output

```bash
Volume group "webdata-vg" successfully created
```

Verify the Volume Group is created.

```bash
sudo vgs
```

output

```bash
VG         #PV #LV #SN Attr   VSize   VFree
webdata-vg   3   0   0 wz--n- <29.99g <29.99g
```

4. Use `lvcreate` utility to create 2 logical volumes named `apps-lv` . We use half of the PV size and `logs-lv` to use the remaining space

```bash
sudo lvcreate -n apps-lv -L 14G webdata-vg
sudo lvcreate -n logs-lv -L 14G webdata-vg
```

output

```bash
[ec2-user@ip-172-31-88-7 ~]$ sudo lvcreate -n apps-lv -L 14G webdata-vg
  Logical volume "apps-lv" created.
[ec2-user@ip-172-31-88-7 ~]$ sudo lvcreate -n logs-lv -L 14G webdata-vg
  Logical volume "logs-lv" created.
[ec2-user@ip-172-31-88-7 ~]$
```

We, verify that our Logical Volume is created successfully.

```bash
sudo lvs
```

output

```bash
LV      VG         Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  apps-lv webdata-vg -wi-a----- 14.00g
  logs-lv webdata-vg -wi-a----- 14.00g
```

5. Verify the entire setup

```bash
sudo vgdisplay -v
```

output

```bash
--- Volume group ---
  VG Name               webdata-vg
  System ID
  Format                lvm2
  Metadata Areas        3
  Metadata Sequence No  3
  VG Access             read/write
  VG Status             resizable
  MAX LV                0
  Cur LV                2
  Open LV               0
  Max PV                0
  Cur PV                3
  Act PV                3
  VG Size               <29.99 GiB
  PE Size               4.00 MiB
  Total PE              7677
  Alloc PE / Size       7168 / 28.00 GiB
  Free  PE / Size       509 / <1.99 GiB
  VG UUID               B5B8Yf-ufYu-2kdv-555Q-v7SZ-ChV9-YJUGsm

  --- Logical volume ---
  LV Path                /dev/webdata-vg/apps-lv
  LV Name                apps-lv
  VG Name                webdata-vg
  LV UUID                MHtfOl-LeOU-vpf5-DoJM-OADF-tnWS-egS2Mq
  LV Write Access        read/write
  LV Creation host, time ip-172-31-88-7.ec2.internal, 2021-07-02 19:51:00 +0000
  LV Status              available
  # open                 0
  LV Size                14.00 GiB
  Current LE             3584
  Segments               2
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     256
  Block device           253:0

  --- Logical volume ---
  LV Path                /dev/webdata-vg/logs-lv
  LV Name                logs-lv
  VG Name                webdata-vg
  LV UUID                L9aZda-6RVx-CtPj-BnJw-TnvT-kkTO-HsUq0Y
  LV Write Access        read/write
  LV Creation host, time ip-172-31-88-7.ec2.internal, 2021-07-02 19:51:21 +0000
  LV Status              available
  # open                 0
  LV Size                14.00 GiB
  Current LE             3584
  Segments               2
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     256
  Block device           253:1

  --- Physical volumes ---
  PV Name               /dev/sdh1
  PV UUID               qSw7vo-AwpW-auyU-cIoN-Qyo0-DZ9B-952AOB
  PV Status             allocatable
  Total PE / Free PE    2559 / 0

  PV Name               /dev/sdg1
  PV UUID               14ejDf-PqM6-1hvQ-Za2n-ZFBx-R0Wd-MlREtR
  PV Status             allocatable
  Total PE / Free PE    2559 / 509

  PV Name               /dev/sdf1
  PV UUID               AO6HPt-ADw2-PR2C-vUlb-mf7C-NXhw-gD7G9M
  PV Status             allocatable
  Total PE / Free PE    2559 / 0
  ```

  ```bash
  sudo lsblk 
  ```

  output

```bash
NAME                     MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
xvda                     202:0    0   8G  0 disk
└─xvda1                  202:1    0   8G  0 part /
xvdf                     202:80   0  10G  0 disk
└─xvdf1                  202:81   0  10G  0 part
  └─webdata--vg-logs--lv 253:1    0  14G  0 lvm
xvdg                     202:96   0  10G  0 disk
└─xvdg1                  202:97   0  10G  0 part
  ├─webdata--vg-apps--lv 253:0    0  14G  0 lvm
  └─webdata--vg-logs--lv 253:1    0  14G  0 lvm
xvdh                     202:112  0  10G  0 disk
└─xvdh1                  202:113  0  10G  0 part
  └─webdata--vg-apps--lv 253:0    0  14G  0 lvm
```

6. Format the logical volumes with _ext4_ filesystem .

```bash
sudo mkfs -t ext4 /dev/webdata-vg/apps-lv
sudo mkfs -t ext4 /dev/webdata-vg/logs-lv
```


output for webdata-vg/apps-lv

```bash
mke2fs 1.42.9 (28-Dec-2013)
Filesystem label=
OS type: Linux
Block size=4096 (log=2)
Fragment size=4096 (log=2)
Stride=0 blocks, Stripe width=0 blocks
917504 inodes, 3670016 blocks
183500 blocks (5.00%) reserved for the super user
First data block=0
Maximum filesystem blocks=2151677952
112 block groups
32768 blocks per group, 32768 fragments per group
8192 inodes per group
Superblock backups stored on blocks:
        32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208

Allocating group tables: done
Writing inode tables: done
Creating journal (32768 blocks): done
Writing superblocks and filesystem accounting information: done
```

output for webdata-vg/logs-lv

```bash
mke2fs 1.42.9 (28-Dec-2013)
Filesystem label=
OS type: Linux
Block size=4096 (log=2)
Fragment size=4096 (log=2)
Stride=0 blocks, Stripe width=0 blocks
917504 inodes, 3670016 blocks
183500 blocks (5.00%) reserved for the super user
First data block=0
Maximum filesystem blocks=2151677952
112 block groups
32768 blocks per group, 32768 fragments per group
8192 inodes per group
Superblock backups stored on blocks:
        32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208

Allocating group tables: done
Writing inode tables: done
Creating journal (32768 blocks): done
Writing superblocks and filesystem accounting information: done
```

7. Create directory /var/www/html to store website files.

```bash
sudo mkdir -p /var/www/html
```

8. Create /home/recovery/logs to syore backup of log data

```bash
sudo mkdir -p /home/recovery/logs
```
9. Create a mount point /var/www/html to mount apps-lv logical volume .

```bash
sudo mount /dev/webdata-vg/apps-lv /var/www/html/
```

Check if logical volume is mounted

```bash
df -hT
```

output
```bash
Filesystem                       Type      Size  Used Avail Use% Mounted on
devtmpfs                         devtmpfs  482M     0  482M   0% /dev
tmpfs                            tmpfs     492M     0  492M   0% /dev/shm
tmpfs                            tmpfs     492M  472K  492M   1% /run
tmpfs                            tmpfs     492M     0  492M   0% /sys/fs/cgroup
/dev/xvda1                       xfs       8.0G  1.5G  6.6G  18% /
tmpfs                            tmpfs      99M     0   99M   0% /run/user/1000
/dev/mapper/webdata--vg-apps--lv ext4       14G   41M   13G   1% /var/www/html
```

10. Use _rsync_ utility to backup all files in the log directory /var/log into /home.recovery/logs (This is required before counting the filesystem)

```bash
sudo rsync -av /var/log/. /home/recovery/logs/
```

output
```bash
sending incremental file list
./
boot.log
btmp
cloud-init-output.log
cloud-init.log
cron
dmesg
grubby_prune_debug
lastlog
maillog
messages
secure
spooler
tallylog
wtmp
yum.log
amazon/
amazon/ssm/
amazon/ssm/amazon-ssm-agent.log
amazon/ssm/hibernate.log
amazon/ssm/audits/
amazon/ssm/audits/amazon-ssm-agent-audit-2021-07-02
audit/
audit/audit.log
chrony/
journal/
journal/ec241e799eaf2c0ee222f87da91ab53c/
journal/ec241e799eaf2c0ee222f87da91ab53c/system.journal
sa/
sa/sa02

sent 9,248,884 bytes  received 466 bytes  18,498,700.00 bytes/sec
total size is 9,244,828  speedup is 1.00
```

10. Mount /var/log on logs-lv i.e. Make /var/log a mount point and mount logs-lv logical volume.

```bash
sudo mount /dev/webdata-vg/logs-lv /var/log
```
Checking if mount is successful.

```bash
df -hT
```

output

```bash
Filesystem                       Type      Size  Used Avail Use% Mounted on
devtmpfs                         devtmpfs  482M     0  482M   0% /dev
tmpfs                            tmpfs     492M     0  492M   0% /dev/shm
tmpfs                            tmpfs     492M  472K  492M   1% /run
tmpfs                            tmpfs     492M     0  492M   0% /sys/fs/cgroup
/dev/xvda1                       xfs       8.0G  1.5G  6.6G  19% /
tmpfs                            tmpfs      99M     0   99M   0% /run/user/1000
/dev/mapper/webdata--vg-apps--lv ext4       14G   41M   13G   1% /var/www/html
/dev/mapper/webdata--vg-logs--lv ext4       14G   41M   13G   1% /var/log
```

11. Restore log file back into /var/log directory

```bash
sudo rsync -av /home/recovery/logs/log/. /var/log
```

12. Edit _/etc/fstab_ so that mount configuration will persist after reboot of the server. We will use the _UUID_ of the device to update _/etc/fstab_ .

Use _sudo blkid_ to get the UUID .

output
```bash
/dev/xvda1: LABEL="/" UUID="8562e9fb-f45b-4a09-9778-bde97be4afb3" TYPE="xfs" PARTLABEL="Linux" PARTUUID="5e8ed354-3406-4942-9b72-a557417e17d6"
/dev/xvdf1: UUID="AO6HPt-ADw2-PR2C-vUlb-mf7C-NXhw-gD7G9M" TYPE="LVM2_member" PARTLABEL="Linux LVM" PARTUUID="586afa65-010e-4936-bb89-9f8f1b59fa79"
/dev/xvdg1: UUID="14ejDf-PqM6-1hvQ-Za2n-ZFBx-R0Wd-MlREtR" TYPE="LVM2_member" PARTLABEL="Linux LVM" PARTUUID="dbb1cbbe-7201-43d7-b3b6-5a4535383086"
/dev/xvdh1: UUID="qSw7vo-AwpW-auyU-cIoN-Qyo0-DZ9B-952AOB" TYPE="LVM2_member" PARTLABEL="Linux LVM" PARTUUID="d6d8e1df-da04-476c-88da-1ed3dda1809d"
/dev/mapper/webdata--vg-apps--lv: UUID="34096a97-de0a-48bf-b6c9-1f9879dac4b2" TYPE="ext4"
/dev/mapper/webdata--vg-logs--lv: UUID="35f95ab8-634a-44d3-a829-cb56e156bf7e" TYPE="ext4"
```

```bash
sudo nano /etc/fstab/
```

![fstab](https://github.com/thinkC/devops-projects/blob/master/img-web-wordpress/img10.PNG?raw=true)

13. Test configuration and reload daemon

```bash 
sudo mount -a
sudo systemctl daemon-reload
```

14. Check if logical volumes are still mounted

```bash
df -hT
```

output

```bash
[ec2-user@ip-172-31-88-7 ~]$ df -hT
Filesystem                       Type      Size  Used Avail Use% Mounted on
devtmpfs                         devtmpfs  482M     0  482M   0% /dev
tmpfs                            tmpfs     492M     0  492M   0% /dev/shm
tmpfs                            tmpfs     492M  488K  492M   1% /run
tmpfs                            tmpfs     492M     0  492M   0% /sys/fs/cgroup
/dev/xvda1                       xfs       8.0G  1.5G  6.6G  19% /
tmpfs                            tmpfs      99M     0   99M   0% /run/user/1000
/dev/mapper/webdata--vg-apps--lv ext4       14G   41M   13G   1% /var/www/html
/dev/mapper/webdata--vg-logs--lv ext4       14G   41M   13G   1% /var/log
```

## Step 2 -  Prepare Database server

We launch another EC2 servr named _DB Server_. We repeat the same steps like we did for the web server but instead of _apps-lv_ logical volume we name it as _db-lv_ logical volume and mount it to _/db_ directory instead of _/var/www/html_.

## Step 3 - Install Wordpress on Web server EC2

We do the following to install wordpress

1. Update repository
```bash
sudo yum -y update
```

2. Install _wget_, _Apache_, and its dependencies.

```bash
sudo yum -y install wget httpd php php-mysqlnd php-fpm php-json
```

3. Start Apache

```bash
sudo systemctl enable httpd
sudo systemctl start httpd
```

output

```bash
[ec2-user@ip-172-31-88-7 ~]$ sudo systemctl enable httpd
Created symlink from /etc/systemd/system/multi-user.target.wants/httpd.service to /usr/lib/systemd/system/httpd.service.
[ec2-user@ip-172-31-88-7 ~]$
```

4. Install PHP and its dependencies

```bash
sudo yum install https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm
sudo yum install yum-utils http://rpms.remirepo.net/enterprise/remi-release-8.rpm
sudo yum module list php
sudo yum module reset php
sudo yum module enable php:remi-7.4
sudo yum install php php-opcache php-gd php-curl php-mysqlnd
sudo systemctl start php-fpm
sudo systemctl enable php-fpm
setsebool -P httpd_execmem 1
```
5. Restart Apache
```bash
sudo systemctl restart httpd
```


6. Download Wordpress and copy wordpress to var/www/html
```bash
mkdir wordpress
cd   wordpress
sudo wget http://wordpress.org/latest.tar.gz
sudo tar xzvf latest.tar.gz
sudo rm -rf latest.tar.gz
sudo cp wordpress/wp-config-sample.php wordpress/wp-config.php
sudo cp -R wordpress /var/www/html/
```
7. Configure SELinux Policies
```bash
 sudo chown -R apache:apache /var/www/html/wordpress
 sudo chcon -t httpd_sys_rw_content_t /var/www/html/wordpress -R
 sudo setsebool -P httpd_can_network_connect=1
 ```

 ## Step 4 - Install MariaDB on your DB Server EC2

 ```bash
sudo yum update
#sudo yum install mysql-server
sudoyum install mariadb-server mariadb-libs mariadb
```

Check status of mariadb 
```bash
sudo systemctl status mariadb
```
output

```bash
[ec2-user@ip-172-31-78-58 ~]$ sudo systemctl status mariadb
● mariadb.service - MariaDB database server
   Loaded: loaded (/usr/lib/systemd/system/mariadb.service; disabled; vendor preset: disabled)
   Active: active (running) since Sat 2021-07-03 09:45:04 UTC; 4s ago
  Process: 1132 ExecStartPost=/usr/libexec/mariadb-wait-ready $MAINPID (code=exited, status=0/SUCCESS)
  Process: 1049 ExecStartPre=/usr/libexec/mariadb-prepare-db-dir %n (code=exited, status=0/SUCCESS)
 Main PID: 1131 (mysqld_safe)
   CGroup: /system.slice/mariadb.service
           ├─1131 /bin/sh /usr/bin/mysqld_safe --basedir=/usr
           └─1297 /usr/libexec/mysqld --basedir=/usr --datadir=/var/lib/mysql --plugin-dir=/us...
[ec2-user@ip-172-31-78-58 ~]$
```

If it is not running run 

```bash
sudo systemctl start mariadb
```

## Step 5 - Configure DB to work with WordPress

```bash
sudo mysql
CREATE DATABASE wordpress;
CREATE USER `myuser`@`<Web-Server-Private-IP-Address>` IDENTIFIED BY 'mypass';
GRANT ALL ON wordpress.* TO 'myuser'@'<Web-Server-Private-IP-Address>';
FLUSH PRIVILEGES;
SHOW DATABASES;
exit
```

Typing sudo mysql gives output below

```sql
[ec2-user@ip-172-31-78-58 ~]$ sudo mysql
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 2
Server version: 5.5.68-MariaDB MariaDB Server

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MariaDB [(none)]>
```

output of above command

```bash
MariaDB [(none)]> CREATE DATABASE wordpress;
Query OK, 1 row affected (0.00 sec)

MariaDB [(none)]> CREATE USER 'myuser'@'172.31.88.7' IDENTIFIED BY 'mypass';
Query OK, 0 rows affected (0.00 sec)

MariaDB [(none)]> GRANT ALL ON wordpress.* TO 'myuser'@'172.31.88.7';
Query OK, 0 rows affected (0.00 sec)

MariaDB [(none)]> FLUSH PRIVILEGES;
Query OK, 0 rows affected (0.00 sec)

MariaDB [(none)]> SHOW DATABASES;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| test               |
| wordpress          |
+--------------------+
5 rows in set (0.00 sec)

MariaDB [(none)]>
MariaDB [(none)]> exit
Bye
[ec2-user@ip-172-31-78-58 ~]$
```
## Step 6 - Configure WordPress to connect to remote database.

First we make sure that we allow port 3306 on the DB server to allow connection from only the web server.

![allow port 3306](https://github.com/thinkC/devops-projects/blob/master/img-web-wordpress/img11.PNG?raw=true)

1. Install MariaDB client on the web server
```bash
sudo yum -y install mariadb
sudo mysql -u myuser -p -h 172.31.78.58
```
2. Check you can successfully execute `SHOW DATABASES`

output

```sql
MariaDB [(none)]> SHOW DATABASES;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| test               |
| wordpress          |
+--------------------+
3 rows in set (0.00 sec)

MariaDB [(none)]>
```

4. Allow HTTP port 80 on the web server

![http port](https://github.com/thinkC/devops-projects/blob/master/img-web-wordpress/img12.PNG?raw=true)


```bash
[ec2-user@ip-172-31-88-7 ~]$ sudo systemctl status php-fpm
● php-fpm.service - The PHP FastCGI Process Manager
   Loaded: loaded (/usr/lib/systemd/system/php-fpm.service; enabled; vendor preset: disabled)
   Active: active (running) since Sat 2021-07-03 11:10:28 UTC; 45min ago
 Main PID: 2896 (php-fpm)
   Status: "Processes active: 0, idle: 5, Requests: 0, slow: 0, Traffic: 0req/sec"
   CGroup: /system.slice/php-fpm.service
           ├─2896 php-fpm: master process (/etc/php-fpm.conf)
           ├─2917 php-fpm: pool www
           ├─2918 php-fpm: pool www
           ├─2919 php-fpm: pool www
           ├─2920 php-fpm: pool www
           └─2921 php-fpm: pool www

Jul 03 11:10:28 ip-172-31-88-7.ec2.internal systemd[1]: Starting The PHP FastCGI Process Manager...
Jul 03 11:10:28 ip-172-31-88-7.ec2.internal systemd[1]: Started The PHP FastCGI Process Manager.
```

5. We now try to access the wordpress site from the public ip address, but I go the error below

![wordpress site](https://github.com/thinkC/devops-projects/blob/master/img-web-wordpress/img13.PNG?raw=true)

`error` _Your server is running PHP version 5.4.16 but WordPress 5.7.requires at least 5.6.20_.

So I needded to upgrade PHP to a higer version

```bash
sudo yum install amazon-linux-extras -y
```

output

```bash
Loaded plugins: extras_suggestions, langpacks, priorities, update-motd
Package amazon-linux-extras-2.0.0-1.amzn2.noarch already installed and latest version
Nothing to do
```

```bash
sudo amazon-linux-extras | grep php
```

output
```bash
15  php7.2                   available    \
 17  lamp-mariadb10.2-php7.2  available    \
 31  php7.3                   available    \
 42  php7.4                   available    [ =stable ]
 51  php8.0                   available    [ =stable ]
 ```

 ```bash
 sudo amazon-linux-extras enable php7.4
 ```

 output

 ```bash
 0  ansible2                 available    \
        [ =2.4.2  =2.4.6  =2.8  =stable ]
  2  httpd_modules            available    [ =1.0  =stable ]
  3  memcached1.5             available    \
        [ =1.5.1  =1.5.16  =1.5.17 ]
  5  postgresql9.6            available    \
        [ =9.6.6  =9.6.8  =stable ]
  6  postgresql10             available    [ =10  =stable ]
  9  R3.4                     available    [ =3.4.3  =stable ]
 10  rust1                    available    \
        [ =1.22.1  =1.26.0  =1.26.1  =1.27.2  =1.31.0  =1.38.0
          =stable ]
 11  vim                      available    [ =8.0  =stable ]
  _  php7.2                   available    \
        [ =7.2.0  =7.2.4  =7.2.5  =7.2.8  =7.2.11  =7.2.13  =7.2.14
          =7.2.16  =7.2.17  =7.2.19  =7.2.21  =7.2.22  =7.2.23
          =7.2.24  =7.2.26  =stable ]
  _  lamp-mariadb10.2-php7.2  available    \
        [ =10.2.10_7.2.0  =10.2.10_7.2.4  =10.2.10_7.2.5
          =10.2.10_7.2.8  =10.2.10_7.2.11  =10.2.10_7.2.13
          =10.2.10_7.2.14  =10.2.10_7.2.16  =10.2.10_7.2.17
          =10.2.10_7.2.19  =10.2.10_7.2.22  =10.2.10_7.2.23
          =10.2.10_7.2.24  =stable ]
 18  libreoffice              available    \
        [ =5.0.6.2_15  =5.3.6.1  =stable ]
 19  gimp                     available    [ =2.8.22 ]
 20  docker=latest            enabled      \
        [ =17.12.1  =18.03.1  =18.06.1  =18.09.9  =stable ]
 21  mate-desktop1.x          available    \
        [ =1.19.0  =1.20.0  =stable ]
 22  GraphicsMagick1.3        available    \
        [ =1.3.29  =1.3.32  =1.3.34  =stable ]
 23  tomcat8.5                available    \
        [ =8.5.31  =8.5.32  =8.5.38  =8.5.40  =8.5.42  =8.5.50
          =stable ]
 24  epel                     available    [ =7.11  =stable ]
 25  testing                  available    [ =1.0  =stable ]
 26  ecs                      available    [ =stable ]
 27  corretto8                available    \
        [ =1.8.0_192  =1.8.0_202  =1.8.0_212  =1.8.0_222  =1.8.0_232
          =1.8.0_242  =stable ]
 28  firecracker              available    [ =0.11  =stable ]
 29  golang1.11               available    \
        [ =1.11.3  =1.11.11  =1.11.13  =stable ]
 30  squid4                   available    [ =4  =stable ]
  _  php7.3                   available    \
        [ =7.3.2  =7.3.3  =7.3.4  =7.3.6  =7.3.8  =7.3.9  =7.3.10
          =7.3.11  =7.3.13  =stable ]
 32  lustre2.10               available    \
        [ =2.10.5  =2.10.8  =stable ]
 33  java-openjdk11           available    [ =11  =stable ]
 34  lynis                    available    [ =stable ]
 35  kernel-ng                available    [ =stable ]
 36  BCC                      available    [ =0.x  =stable ]
 37  mono                     available    [ =5.x  =stable ]
 38  nginx1                   available    [ =stable ]
 39  ruby2.6                  available    [ =2.6  =stable ]
 40  mock                     available    [ =stable ]
 41  postgresql11             available    [ =11  =stable ]
 42  php7.4=latest            enabled      [ =stable ]
 43  livepatch                available    [ =stable ]
 44  python3.8                available    [ =stable ]
 45  haproxy2                 available    [ =stable ]
 46  collectd                 available    [ =stable ]
 47  aws-nitro-enclaves-cli   available    [ =stable ]
 48  R4                       available    [ =stable ]
 49  kernel-5.4               available    [ =stable ]
 50  selinux-ng               available    [ =stable ]
  _  php8.0                   available    [ =stable ]
 52  tomcat9                  available    [ =stable ]
 53  unbound1.13              available    [ =stable ]
 54  mariadb10.5              available    [ =stable ]
 55  kernel-5.10              available    [ =stable ]
 56  redis6                   available    [ =stable ]
 57  ruby3.0                  available    [ =stable ]
 58  postgresql12             available    [ =stable ]
 59  postgresql13             available    [ =stable ]
 60  mock2                    available    [ =stable ]

Now you can install:
 # yum clean metadata
 # yum install php-cli php-pdo php-fpm php-json php-mysqlnd
 ```

 ```bash
 sudo yum clean metadata
 ```

 output

 ```bash
 Loaded plugins: extras_suggestions, langpacks, priorities, update-motd
Cleaning repos: amzn2-core amzn2extra-docker amzn2extra-php7.4
12 metadata files removed
4 sqlite files removed
0 metadata files removed
[ec2-user@ip-172-31-88-7 ~]$ sudo yum install php-cli php-pdo php-fpm php-json php-mysqlnd
Loaded plugins: extras_suggestions, langpacks, priorities, update-motd
amzn2-core                                                                | 3.7 kB  00:00:00
amzn2extra-docker                                                         | 3.0 kB  00:00:00
amzn2extra-php7.4                                                         | 3.0 kB  00:00:00
(1/7): amzn2-core/2/x86_64/group_gz                                       | 2.5 kB  00:00:00
(2/7): amzn2-core/2/x86_64/updateinfo                                     | 395 kB  00:00:00
(3/7): amzn2extra-php7.4/2/x86_64/primary_db                              | 250 kB  00:00:00
(4/7): amzn2extra-docker/2/x86_64/updateinfo                              |   76 B  00:00:00
(5/7): amzn2extra-php7.4/2/x86_64/updateinfo                              |   76 B  00:00:00
(6/7): amzn2extra-docker/2/x86_64/primary_db                              |  78 kB  00:00:00
(7/7): amzn2-core/2/x86_64/primary_db                                     |  54 MB  00:00:01
Resolving Dependencies
--> Running transaction check
---> Package php-cli.x86_64 0:5.4.16-46.amzn2.0.2 will be updated
--> Processing Dependency: php-cli(x86-64) = 5.4.16-46.amzn2.0.2 for package: php-5.4.16-46.amzn2.0.2.x86_64
---> Package php-cli.x86_64 0:7.4.19-1.amzn2 will be an update
--> Processing Dependency: php-common(x86-64) = 7.4.19-1.amzn2 for package: php-cli-7.4.19-1.amzn2.x86_64
---> Package php-fpm.x86_64 0:5.4.16-46.amzn2.0.2 will be updated
---> Package php-fpm.x86_64 0:7.4.19-1.amzn2 will be an update
---> Package php-json.x86_64 0:7.4.19-1.amzn2 will be installed
---> Package php-mysqlnd.x86_64 0:5.4.16-46.amzn2.0.2 will be updated
---> Package php-mysqlnd.x86_64 0:7.4.19-1.amzn2 will be an update
---> Package php-pdo.x86_64 0:5.4.16-46.amzn2.0.2 will be updated
---> Package php-pdo.x86_64 0:7.4.19-1.amzn2 will be an update
--> Running transaction check
---> Package php.x86_64 0:5.4.16-46.amzn2.0.2 will be updated
---> Package php.x86_64 0:7.4.19-1.amzn2 will be an update
---> Package php-common.x86_64 0:5.4.16-46.amzn2.0.2 will be updated
--> Processing Dependency: php-common(x86-64) = 5.4.16-46.amzn2.0.2 for package: php-gd-5.4.16-46.amzn2.0.2.x86_64
---> Package php-common.x86_64 0:7.4.19-1.amzn2 will be an update
--> Processing Dependency: libzip.so.5()(64bit) for package: php-common-7.4.19-1.amzn2.x86_64
--> Running transaction check
---> Package libzip.x86_64 0:1.3.2-1.amzn2.0.1 will be installed
---> Package php-gd.x86_64 0:5.4.16-46.amzn2.0.2 will be updated
---> Package php-gd.x86_64 0:7.4.19-1.amzn2 will be an update
--> Finished Dependency Resolution

Dependencies Resolved

=================================================================================================
 Package             Arch           Version                      Repository                 Size
=================================================================================================
Installing:
 php-json            x86_64         7.4.19-1.amzn2               amzn2extra-php7.4          71 k
Updating:
 php-cli             x86_64         7.4.19-1.amzn2               amzn2extra-php7.4         4.9 M
 php-fpm             x86_64         7.4.19-1.amzn2               amzn2extra-php7.4         1.7 M
 php-mysqlnd         x86_64         7.4.19-1.amzn2               amzn2extra-php7.4         240 k
 php-pdo             x86_64         7.4.19-1.amzn2               amzn2extra-php7.4         134 k
Installing for dependencies:
 libzip              x86_64         1.3.2-1.amzn2.0.1            amzn2-core                 62 k
Updating for dependencies:
 php                 x86_64         7.4.19-1.amzn2               amzn2extra-php7.4         3.2 M
 php-common          x86_64         7.4.19-1.amzn2               amzn2extra-php7.4         1.1 M
 php-gd              x86_64         7.4.19-1.amzn2               amzn2extra-php7.4         182 k

Transaction Summary
=================================================================================================
Install  1 Package  (+1 Dependent package)
Upgrade  4 Packages (+3 Dependent packages)

Total download size: 12 M
Is this ok [y/d/N]: y
Downloading packages:
Delta RPMs disabled because /usr/bin/applydeltarpm not installed.
(1/9): libzip-1.3.2-1.amzn2.0.1.x86_64.rpm                                |  62 kB  00:00:00
(2/9): php-7.4.19-1.amzn2.x86_64.rpm                                      | 3.2 MB  00:00:00
(3/9): php-cli-7.4.19-1.amzn2.x86_64.rpm                                  | 4.9 MB  00:00:00
(4/9): php-common-7.4.19-1.amzn2.x86_64.rpm                               | 1.1 MB  00:00:00
(5/9): php-fpm-7.4.19-1.amzn2.x86_64.rpm                                  | 1.7 MB  00:00:00
(6/9): php-gd-7.4.19-1.amzn2.x86_64.rpm                                   | 182 kB  00:00:00
(7/9): php-json-7.4.19-1.amzn2.x86_64.rpm                                 |  71 kB  00:00:00
(8/9): php-mysqlnd-7.4.19-1.amzn2.x86_64.rpm                              | 240 kB  00:00:00
(9/9): php-pdo-7.4.19-1.amzn2.x86_64.rpm                                  | 134 kB  00:00:00
-------------------------------------------------------------------------------------------------
Total                                                             17 MB/s |  12 MB  00:00:00
Running transaction check
Running transaction test
Transaction test succeeded
Running transaction
  Installing : libzip-1.3.2-1.amzn2.0.1.x86_64                                              1/16
  Installing : php-json-7.4.19-1.amzn2.x86_64                                               2/16
  Updating   : php-common-7.4.19-1.amzn2.x86_64                                             3/16
  Updating   : php-cli-7.4.19-1.amzn2.x86_64                                                4/16
  Updating   : php-pdo-7.4.19-1.amzn2.x86_64                                                5/16
  Updating   : php-mysqlnd-7.4.19-1.amzn2.x86_64                                            6/16
  Updating   : php-7.4.19-1.amzn2.x86_64                                                    7/16
  Updating   : php-fpm-7.4.19-1.amzn2.x86_64                                                8/16
  Updating   : php-gd-7.4.19-1.amzn2.x86_64                                                 9/16
  Cleanup    : php-5.4.16-46.amzn2.0.2.x86_64                                              10/16
  Cleanup    : php-cli-5.4.16-46.amzn2.0.2.x86_64                                          11/16
  Cleanup    : php-gd-5.4.16-46.amzn2.0.2.x86_64                                           12/16
  Cleanup    : php-mysqlnd-5.4.16-46.amzn2.0.2.x86_64                                      13/16
  Cleanup    : php-pdo-5.4.16-46.amzn2.0.2.x86_64                                          14/16
  Cleanup    : php-fpm-5.4.16-46.amzn2.0.2.x86_64                                          15/16
  Cleanup    : php-common-5.4.16-46.amzn2.0.2.x86_64                                       16/16
  Verifying  : php-cli-7.4.19-1.amzn2.x86_64                                                1/16
  Verifying  : php-fpm-7.4.19-1.amzn2.x86_64                                                2/16
  Verifying  : php-pdo-7.4.19-1.amzn2.x86_64                                                3/16
  Verifying  : php-common-7.4.19-1.amzn2.x86_64                                             4/16
  Verifying  : libzip-1.3.2-1.amzn2.0.1.x86_64                                              5/16
  Verifying  : php-json-7.4.19-1.amzn2.x86_64                                               6/16
  Verifying  : php-mysqlnd-7.4.19-1.amzn2.x86_64                                            7/16
  Verifying  : php-gd-7.4.19-1.amzn2.x86_64                                                 8/16
  Verifying  : php-7.4.19-1.amzn2.x86_64                                                    9/16
  Verifying  : php-fpm-5.4.16-46.amzn2.0.2.x86_64                                          10/16
  Verifying  : php-cli-5.4.16-46.amzn2.0.2.x86_64                                          11/16
  Verifying  : php-gd-5.4.16-46.amzn2.0.2.x86_64                                           12/16
  Verifying  : php-5.4.16-46.amzn2.0.2.x86_64                                              13/16
  Verifying  : php-pdo-5.4.16-46.amzn2.0.2.x86_64                                          14/16
  Verifying  : php-mysqlnd-5.4.16-46.amzn2.0.2.x86_64                                      15/16
  Verifying  : php-common-5.4.16-46.amzn2.0.2.x86_64                                       16/16

Installed:
  php-json.x86_64 0:7.4.19-1.amzn2

Dependency Installed:
  libzip.x86_64 0:1.3.2-1.amzn2.0.1

Updated:
  php-cli.x86_64 0:7.4.19-1.amzn2                   php-fpm.x86_64 0:7.4.19-1.amzn2
  php-mysqlnd.x86_64 0:7.4.19-1.amzn2               php-pdo.x86_64 0:7.4.19-1.amzn2

Dependency Updated:
  php.x86_64 0:7.4.19-1.amzn2 php-common.x86_64 0:7.4.19-1.amzn2 php-gd.x86_64 0:7.4.19-1.amzn2

Complete!
```

```bash
php --version
```

output

```bash
PHP 7.4.19 (cli) (built: May 13 2021 22:36:40) ( NTS )
Copyright (c) The PHP Group
Zend Engine v3.4.0, Copyright (c) Zend Technologies
[ec2-user@ip-172-31-88-7 ~]$ sudo systemctl start php-fpm
[ec2-user@ip-172-31-88-7 ~]$ sudo systemctl enable php-fpm
```

We now configure the we server to allow remote connection . Add the bind address as below

Add /etc/my.conf
```bash
sudo nano /etc/my.cnf
```

![bind address](https://github.com/thinkC/devops-projects/blob/master/img-web-wordpress/img14a.PNG?raw=true)


Restart mariadb sql service

```bash
sudo systemctl restart mariadb
```

On the web server , we update the wp-config.php file

```bash
sudo nano wp-config.php
```
And we edit the database name, username, password, for DB_HOST, the changed it from localhost to the Private IP address of the Database server.

![wp-config](https://github.com/thinkC/devops-projects/blob/master/img-web-wordpress/img21.PNG?raw=true)

![wordpress](https://github.com/thinkC/devops-projects/blob/master/img-web-wordpress/img15.PNG?raw=true)

![wordpress](https://github.com/thinkC/devops-projects/blob/master/img-web-wordpress/img16.PNG?raw=true)

![wordpress](https://github.com/thinkC/devops-projects/blob/master/img-web-wordpress/img17.PNG?raw=true)

![wordpress](https://github.com/thinkC/devops-projects/blob/master/img-web-wordpress/img18.PNG?raw=true)

![wordpress](https://github.com/thinkC/devops-projects/blob/master/img-web-wordpress/img19.PNG?raw=true)

![wordpress](https://github.com/thinkC/devops-projects/blob/master/img-web-wordpress/img20.PNG?raw=true)



Congratulations we successfully deployed a Wordpress site on a Linux server and hosted the data on another Linux server running MariaDB database.